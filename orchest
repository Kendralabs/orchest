#!/bin/bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

# Make sure the orchest namespace exists. Necessary only if Orchest is
# being installed.
minikube kubectl -- create namespace orchest  > /dev/null 2>&1

# Make sure orchest-ctl has the right permissions.
minikube kubectl -- apply -f "$DIR/deploy/orchest-ctl/rbac" > /dev/null

# Notes:
# 
# currently -it is always used because it's a requirement for --rm.
# 
# The service account is set this way because --serviceaccount is a
# quite recent addition to kubectl. Also
# https://github.com/kubernetes/kubernetes/issues/63214
# 
# --quiet and 2>/dev/null will silence messages from kubectl, not the
# container.
minikube kubectl -- run orchest-ctl \
    --quiet \
    -it \
    --rm \
    --wait \
    --restart=Never \
    --image=orchest/orchest-ctl \
    --image-pull-policy=IfNotPresent \
    --namespace=orchest \
    -l "app=orchest-ctl"
    --overrides='{ "spec": { "serviceAccount": "orchest-ctl" }  }' \
    --env "PYTHONUNBUFFERED=TRUE" \
    -- "$@" 2> /dev/null
